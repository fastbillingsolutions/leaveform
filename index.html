<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FastBillingSolutions Leave Request Form</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  @page { size: A4 portrait; margin: 18mm; }
  html, body {
    height: 100%;
    margin: 0; padding: 0;
    background: #f3f7fb;
    font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: #1b2b3a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box;
  }
  *,*:before,*:after {
    box-sizing: inherit;
  }
  .page {
    width: 90vw;
    max-width: 250mm;
    background: transparent;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    width: 100%;
    max-width: 300mm;
    background: #ffffff;
    border-radius: 10px;
    padding: 20px 28px;
    box-shadow: 0 8px 30px rgba(16,24,40,0.06);
  }
  header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-bottom: 2px;
    user-select: none;
  }
  header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #003366;
    margin: 0;
  }
  .subheading {
    text-align: center;
    font-weight: 600;
    color: #0047AB;
    font-size: 1.2rem;
    margin-bottom: 12px;
  }
  .section-title {
    font-weight: 700;
    background: #dbe9ff;
    padding: 6px 8px;
    border-radius: 6px;
    margin-top: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #002b80;
  }
  .section-title img {
    width: 22px;
  }
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 6px;
    margin-top: 8px;
  }
  td {
    padding: 4px 8px;
    vertical-align: middle;
    white-space: nowrap;
  }
  label {
    user-select: none;
    position: relative;
  }
  label.invalid {
    color: #d32f2f !important;
    font-weight: normal !important;
  }
  label.invalid::before {
    content:"*";
    color: #d32f2f;
    font-weight: normal;
    position:absolute;
    left: -10px;
    top: 30%;
    transform: translateY(-40%);
  }
  input, select, textarea {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid #90caf9;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 0.95rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #1e88e5;
    outline: none;
  }
  textarea {
    min-height: 60px;
    resize: vertical;
  }
  textarea.invalid {
    border-color: #d32f2f !important;
    font-weight: 700 !important;
  }
  .submit-row {
    display: flex;
    justify-content: center;
    margin-top: 16px;
  }
  .submit-btn {
    background-color: #1565c0;
    color: #fff;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    font-size: 1.1rem;
    transition: background-color 0.3s ease;
  }
  .submit-btn:hover:not(:disabled) {
    background-color: #0d47a1;
  }
  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  #status {
    margin-top: 14px;
    color: #1565c0;
    font-size: 1rem;
    text-align: center;
    min-height: 24px;
  }
  .note-message {
    margin: 8px 0 12px;
    padding: 8px;
    color: #1565c0;
    font-weight: 400;
    font-size: 0.9rem;
  }
  @media print {
    body {
      background: white;
    }
    .card {
      box-shadow: none;
      border: none;
      padding: 0;
    }
    .submit-row {
      display: none;
    }
  }
</style>
</head>
<body>

<div class="page">
  <div class="card" id="formContainer" aria-label="Leave Request Form">

    <header>
      <h1>Fast Billing Solutions</h1>
    </header>

    <div class="subheading">Employee Leave Request Form</div>

    <div class="section-title">
      <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Employee Icon" />
      Employee Information
    </div>
    <table>
      <tr>
        <td style="width:18%"><label for="employeeName" id="labelEmployeeName">Employee Name:</label></td>
        <td style="width:32%"><input type="text" id="employeeName" placeholder="e.g. Alex" /></td>
        <td style="width:18%"><label for="designation" id="labelDesignation">Designation:</label></td>
        <td style="width:32%"><input type="text" id="designation" placeholder="e.g. Billing Executive" /></td>
      </tr>
      <tr>
        <td><label for="department" id="labelDepartment">Team / Department:</label></td>
        <td><input type="text" id="department" placeholder="e.g. Labs" /></td>
        <td><label for="date" id="labelDate">Date:</label></td>
        <td><input type="date" id="date" /></td>
      </tr>
    </table>

    <div class="section-title">
      <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" alt="Leave Icon" />
      Leave Details
    </div>
    <table>
      <tr>
        <td style="width:20%"><label for="startDate" id="labelStartDate">Leave Start Date:</label></td>
        <td style="width:30%"><input type="date" id="startDate" /></td>
        <td style="width:20%"><label for="endDate" id="labelEndDate">Leave End Date:</label></td>
        <td style="width:30%"><input type="date" id="endDate" /></td>
      </tr>
      <tr>
        <td><label for="days" id="labelDays">No. of Days:</label></td>
        <td><input type="number" id="days" readonly placeholder="Auto Calculate" /></td>
        <td><label for="leaveType" id="labelLeaveType">Leave Type:</label></td>
        <td>
          <select id="leaveType">
            <option>Casual Leave</option>
            <option>Sick Leave</option>
            <option>Annual Leave</option>
          </select>
        </td>
      </tr>
      <tr>
        <td style="width:18%;"><label for="leaveDuration" id="labelLeaveDuration">Leave Duration:</label></td>
        <td style="width:32%;">
          <select id="leaveDuration">
            <option value="full">Full Day</option>
            <option value="half">Half Day</option>
          </select>
        </td>
        <td style="width:18%;"><label for="halfLeaveType" id="labelHalfLeaveType">Half Leave Type:</label></td>
        <td style="width:32%;">
          <select id="halfLeaveType">
            <option value="1st">1st Half</option>
            <option value="2nd">2nd Half</option>
          </select>
        </td>
      </tr>
    </table>

    <p><div class="section-title">
      <img src="https://cdn-icons-png.flaticon.com/512/1157/1157109.png" alt="Reason Icon" />
      Reason for Leave
    </div></p>
    <p><textarea id="reason" placeholder="Short description..."></textarea></p2>

    <p class="note-message">
      <strong>Note:</strong> Our online Adherence portal is currently undergoing processing. While in the testing phase, we are providing only the application form for your use. To apply for leave, please complete the form, download it as a JPG image, and email the attachment to the appropriate individuals.
    </p>

    <div class="submit-row">
      <button class="submit-btn" id="submitBtn" type="button">Download Form</button>
    </div>

    <div id="status" aria-live="polite"></div>
  </div>
</div>

<script>
  (function () {
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const container = document.getElementById('formContainer');

    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const daysInput = document.getElementById('days');
    const leaveDurationSelect = document.getElementById('leaveDuration');
    const halfLeaveTypeSelect = document.getElementById('halfLeaveType');

    const fields = {
      employeeName: document.getElementById('employeeName'),
      designation: document.getElementById('designation'),
      department: document.getElementById('department'),
      date: document.getElementById('date'),
      startDate: startDateInput,
      endDate: endDateInput,
      leaveType: document.getElementById('leaveType'),
      leaveDuration: leaveDurationSelect,
      halfLeaveType: halfLeaveTypeSelect,
      reason: document.getElementById('reason'),
    };

    const labels = {
      employeeName: document.getElementById('labelEmployeeName'),
      designation: document.getElementById('labelDesignation'),
      department: document.getElementById('labelDepartment'),
      date: document.getElementById('labelDate'),
      startDate: document.getElementById('labelStartDate'),
      endDate: document.getElementById('labelEndDate'),
      leaveType: document.getElementById('labelLeaveType'),
      leaveDuration: document.getElementById('labelLeaveDuration'),
      halfLeaveType: document.getElementById('labelHalfLeaveType'),
      reason: null,
    };

    // Update days count
    function updateDays() {
      if (!startDateInput.value || !endDateInput.value) {
        daysInput.value = '';
        return;
      }
      if (leaveDurationSelect.value === 'half') {
        daysInput.value = 0.5;
        return;
      }
      const start = new Date(startDateInput.value);
      const end = new Date(endDateInput.value);
      if (start > end) {
        daysInput.value = '';
        return;
      }
      const diffTime = end - start;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
      daysInput.value = diffDays;
    }

    // Enable/disable halfLeaveType dropdown
    function toggleHalfLeaveType() {
      if (leaveDurationSelect.value === 'full') {
        halfLeaveTypeSelect.disabled = true;
        halfLeaveTypeSelect.style.backgroundColor = '#e0e0e0';
        halfLeaveTypeSelect.style.color = '#888';
      } else {
        halfLeaveTypeSelect.disabled = false;
        halfLeaveTypeSelect.style.backgroundColor = '';
        halfLeaveTypeSelect.style.color = '';
      }
    }

    // Validate form inputs and show red asterisks on missing required fields
    function validateForm() {
      let valid = true;
      // Clear all invalid classes first
      Object.values(labels).forEach(label => {
        if (label) label.classList.remove('invalid');
      });
      fields.reason.classList.remove('invalid');

      // Required fields to check
      const required = [
        'employeeName',
        'designation',
        'department',
        'date',
        'startDate',
        'endDate',
        'leaveType',
        'leaveDuration',
        'reason'
      ];

      for (const key of required) {
        const val = fields[key].value.trim();
        if (!val) {
          if (key === 'reason') {
            fields.reason.classList.add('invalid');
          } else {
            labels[key].classList.add('invalid');
          }
          if (valid) fields[key].focus();
          valid = false;
        }
      }

      // Check if startDate <= endDate
      if (fields.startDate.value && fields.endDate.value) {
        if (new Date(fields.startDate.value) > new Date(fields.endDate.value)) {
          labels.startDate.classList.add('invalid');
          labels.endDate.classList.add('invalid');
          alert('Leave End Date must be after or equal to Leave Start Date.');
          fields.startDate.focus();
          valid = false;
        }
      }

      return valid;
    }

    // Load html2canvas if not loaded
    function loadHtml2canvas() {
      return new Promise((resolve, reject) => {
        if (window.html2canvas) resolve();
        else {
          const script = document.createElement('script');
          script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
          script.onload = () => resolve();
          script.onerror = () => reject();
          document.head.appendChild(script);
        }
      });
    }

    // Generate and download image
    async function generateImage() {
      if (!validateForm()) return;

      submitBtn.disabled = true;
      statusEl.textContent = 'Loading renderer...';

      try {
        await loadHtml2canvas();
      } catch {
        statusEl.textContent = 'Failed to load renderer.';
        alert('Failed to load image renderer.');
        submitBtn.disabled = false;
        return;
      }

      statusEl.textContent = 'Rendering image...';

      try {
        const canvas = await html2canvas(container, {
          useCORS: true,
          scale: 2,
          logging: false
        });
        canvas.toBlob(blob => {
          if (!blob) {
            alert('Failed to create image.');
            submitBtn.disabled = false;
            return;
          }
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'leave_request.jpg';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          statusEl.textContent = 'Form downloaded successfully.';
          submitBtn.disabled = false;
        }, 'image/jpeg', 0.92);
      } catch (e) {
        alert('Error generating image: ' + e.message);
        submitBtn.disabled = false;
      }
    }

    // Event listeners
    startDateInput.addEventListener('change', () => {
      updateDays();
    });
    endDateInput.addEventListener('change', () => {
      updateDays();
    });
    leaveDurationSelect.addEventListener('change', () => {
      toggleHalfLeaveType();
      updateDays();
    });

    // Remove invalid styling on input
    Object.entries(fields).forEach(([key, field]) => {
      field.addEventListener('input', () => {
        if (key === 'reason') {
          if (field.value.trim() !== '') field.classList.remove('invalid');
        } else {
          if (labels[key] && field.value.trim() !== '') labels[key].classList.remove('invalid');
        }
      });
    });

    submitBtn.addEventListener('click', generateImage);

    // Initial states
    toggleHalfLeaveType();
    updateDays();

  })();
</script>

</body>
</html>
