<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FastBillingSolutions Leave Request Form</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  @page { size: A4 portrait; margin: 18mm; }
  html, body {
    height: 100%;
    margin: 0; padding: 0;
    background: #f3f7fb;
    font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color: #1b2b3a;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box;
  }
  *, *:before, *:after {
    box-sizing: inherit;
  }
  .page {
    width: 90vw;
    max-width: 210mm;
    background: transparent;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    width: 100%;
    max-width: 210mm;
    background: #ffffff;
    border-radius: 10px;
    padding: 16px 24px; /* Reduced padding */
    box-shadow: 0 8px 30px rgba(16,24,40,0.06);
  }

  header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-bottom: 6px;
    user-select: none;
  }
  header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1565c0;
    margin: 0;
  }
  .subheading {
    text-align: center;
    font-weight: 600;
    color: #1e88e5;
    font-size: 1.3rem;
    margin-bottom: 24px;
  }

  .section-title {
    font-weight: 700;
    background: #e3f2fd;
    padding: 10px;
    border-radius: 6px;
    margin-top: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #1565c0;
  }
  .section-title img {
    width: 22px;
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 4px; /* Reduced vertical spacing */
    margin-top: 8px;       /* Reduced margin */
  }
  td {
    padding: 4px 8px;      /* Reduced padding */
    vertical-align: middle;
    white-space: nowrap;
  }
  label {
    user-select: none;
    position: relative;
  }
  label.invalid {
    color: #d32f2f !important;
    font-weight: 700 !important;
    position: relative;
  }
  label.invalid::before {
    content: "*";
    color: #d32f2f;
    font-weight: 700;
    position: absolute;
    left: -14px;
    top: 50%;
    transform: translateY(-50%);
  }

  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #90caf9;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #1e88e5;
    outline: none;
  }
  textarea {
    min-height: 60px; /* Reduced height */
    resize: vertical;
  }
  textarea.invalid {
    border-color: #d32f2f !important;
    font-weight: 700 !important;
  }

  .submit-row {
    display: flex;
    justify-content: center;
    margin-top: 28px;
  }
  .submit-btn {
    background-color: #1565c0;
    color: #fff;
    border: none;
    padding: 14px 28px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    font-size: 1.1rem;
    transition: background-color 0.3s ease;
  }
  .submit-btn:hover:not(:disabled) {
    background-color: #0d47a1;
  }
  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  #status {
    margin-top: 14px;
    color: #1565c0;
    font-size: 1rem;
    text-align: center;
    min-height: 24px;
  }

  /* Style for the Note message */
  .note-message {
    margin: 12px 0 20px;
    padding: 10px;
    background: #e3f2fd;
    border-left: 4px solid #1565c0;
    color: #1565c0;
    font-weight: 600;
    border-radius: 4px;
    font-size: 0.95rem;
  }

  @media print {
    body {
      background: white;
    }
    .card {
      box-shadow: none;
      border: none;
      padding: 0;
    }
    .submit-row {
      display: none;
    }
  }
</style>
</head>
<body>

<div class="page">
  <div class="card" id="formContainer" aria-label="Leave Request Form">

    <header>
      <h1>Fast Billing Solutions</h1>
    </header>

    <div class="subheading">Leave Request Form</div>

    <div class="section-title">
      <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt="Employee Icon" />
      Employee Information
    </div>
    <table>
      <tr>
        <td style="width:30%"><label for="employeeName" id="labelEmployeeName">Employee Name:</label></td>
        <td style="width:40%">
          <input type="text" id="employeeName" placeholder="e.g. abc" />
        </td>
        <td style="width:15%"><label for="designation" id="labelDesignation">Designation:</label></td>
        <td style="width:15%">
          <input type="text" id="designation" placeholder="e.g. AR Executive" />
        </td>
      </tr>
      <tr>
        <td><label for="department" id="labelDepartment">Team / Department:</label></td>
        <td>
          <input type="text" id="department" placeholder="e.g. Labs" />
        </td>
        <td><label for="date" id="labelDate">Date:</label></td>
        <td><input type="date" id="date" /></td>
      </tr>
    </table>

    <div class="section-title">
      <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" alt="Leave Icon" />
      Leave Details
    </div>
    <table>
      <tr>
        <td style="width:22%"><label for="startDate" id="labelStartDate">Leave Start Date:</label></td>
        <td style="width:28%"><input type="date" id="startDate" /></td>
        <td style="width:22%"><label for="endDate" id="labelEndDate">Leave End Date:</label></td>
        <td style="width:28%"><input type="date" id="endDate" /></td>
      </tr>
      <tr>
        <td><label for="days" id="labelDays">No. of Days:</label></td>
        <td>
          <input type="number" id="days" readonly placeholder="Auto-calculated" />
        </td>
        <td><label for="leaveType" id="labelLeaveType">Leave Type:</label></td>
        <td>
          <select id="leaveType">
            <option>Casual Leave</option>
            <option>Sick Leave</option>
            <option>Annual Leave</option>
          </select>
        </td>
      </tr>
      <tr>
        <td><label for="leaveDuration" id="labelLeaveDuration">Leave Duration:</label></td>
        <td>
          <select id="leaveDuration">
            <option value="full">Full Day</option>
            <option value="half_morning">Half Day</option>
          </select>
        </td>
        <td></td>
        <td></td>
      </tr>
    </table>

    <div class="section-title">
      <img src="https://cdn-icons-png.flaticon.com/512/1157/1157109.png" alt="Reason Icon" />
      Reason for Leave
    </div>
    <textarea id="reason" placeholder="Short description..."></textarea>

    <!-- Note added here -->
    <p class="note-message">
      <strong>Note:</strong> Our online leave application portal is currently under development. In the meantime, we are sharing the application form with you. To apply for leave, please complete the form, download it as a JPG image, and email the attachment to the concerned persons.
    </p>

    <div class="submit-row">
      <button class="submit-btn" id="submitBtn" type="button">Download Form</button>
    </div>

    <div id="status" aria-live="polite"></div>
  </div>
</div>

<script>
  (function () {
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');
    const containerSelector = '#formContainer';

    const start = document.getElementById('startDate');
    const end = document.getElementById('endDate');
    const days = document.getElementById('days');
    const leaveDuration = document.getElementById('leaveDuration');

    const labels = {
      employeeName: document.getElementById('labelEmployeeName'),
      designation: document.getElementById('labelDesignation'),
      department: document.getElementById('labelDepartment'),
      date: document.getElementById('labelDate'),
      startDate: document.getElementById('labelStartDate'),
      endDate: document.getElementById('labelEndDate'),
      leaveType: document.getElementById('labelLeaveType'),
      leaveDuration: document.getElementById('labelLeaveDuration'),
      reason: null,
    };
    const reasonTextarea = document.getElementById('reason');

    function setStatus(text) {
      statusEl.textContent = text || '';
    }

    function loadScript(url, timeout = 12000) {
      return new Promise((resolve, reject) => {
        if (window.html2canvas) return resolve();
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        let timer = setTimeout(() => {
          s.onerror = s.onload = null;
          reject(new Error('Timeout loading ' + url));
        }, timeout);
        s.onload = () => {
          clearTimeout(timer);
          resolve();
        };
        s.onerror = () => {
          clearTimeout(timer);
          reject(new Error('Failed to load ' + url));
        };
        document.head.appendChild(s);
      });
    }

    function updateDays() {
      const dur = leaveDuration ? leaveDuration.value : 'full';
      if (typeof dur === 'string' && dur.startsWith('half')) {
        days.value = 0.5;
        days.readOnly = true;
        return;
      }
      days.readOnly = true;
      if (!start.value || !end.value) {
        days.value = '';
        return;
      }
      const s = new Date(start.value + 'T00:00:00');
      const e = new Date(end.value + 'T00:00:00');
      if (isNaN(s) || isNaN(e)) {
        days.value = '';
        return;
      }
      const diffDays = Math.round((e - s) / (1000 * 60 * 60 * 24)) + 1;
      days.value = diffDays > 0 ? diffDays : 0;
    }

    function ensureImgsCORS(container) {
      try {
        const imgs = container.querySelectorAll('img');
        imgs.forEach((img) => {
          try {
            img.crossOrigin = 'anonymous';
          } catch (e) {}
        });
      } catch (e) {}
    }

    function clearValidationStyles() {
      Object.values(labels).forEach(label => {
        if (label) {
          label.classList.remove('invalid');
          if(label.dataset.origText) label.textContent = label.dataset.origText;
        }
      });
      reasonTextarea.classList.remove('invalid');
    }

    function validateForm() {
      clearValidationStyles();
      const requiredFields = [
        { id: 'employeeName', name: 'Employee Name' },
        { id: 'designation', name: 'Designation' },
        { id: 'department', name: 'Department' },
        { id: 'date', name: 'Date' },
        { id: 'startDate', name: 'Leave Start Date' },
        { id: 'endDate', name: 'Leave End Date' },
        { id: 'leaveType', name: 'Leave Type' },
        { id: 'leaveDuration', name: 'Leave Duration' },
        { id: 'reason', name: 'Reason for Leave' },
      ];

      for (const field of requiredFields) {
        const el = document.getElementById(field.id);
        const label = labels[field.id];
        if (!el || !el.value || el.value.trim() === '') {
          if (label) {
            label.classList.add('invalid');
          } else if(field.id === 'reason'){
            reasonTextarea.classList.add('invalid');
          }
          alert(`Please fill the "${field.name}" field.`);
          el && el.focus();
          return false;
        }
      }

      if (new Date(start.value) > new Date(end.value)) {
        labels.startDate.classList.add('invalid');
        labels.endDate.classList.add('invalid');
        alert('Leave End Date must be after or equal to Leave Start Date.');
        start.focus();
        return false;
      }

      return true;
    }

    function addInputListeners() {
      Object.entries(labels).forEach(([key, label]) => {
        const el = document.getElementById(key);
        if (!el) return;
        el.addEventListener('input', () => {
          if (label && label.classList.contains('invalid') && el.value.trim() !== '') {
            label.classList.remove('invalid');
          }
        });
      });
      reasonTextarea.addEventListener('input', () => {
        if (reasonTextarea.classList.contains('invalid') && reasonTextarea.value.trim() !== '') {
          reasonTextarea.classList.remove('invalid');
        }
      });
    }

    async function submitHandler() {
      if (!validateForm()) {
        return;
      }

      submitBtn.disabled = true;
      setStatus('Preparing the form image...');

      const container = document.querySelector(containerSelector);
      if (!container) {
        alert('Form container not found.');
        submitBtn.disabled = false;
        return;
      }

      ensureImgsCORS(container);

      try {
        setStatus('Loading renderer (html2canvas)...');
        await loadScript(
          'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
        );
      } catch (err) {
        console.warn('html2canvas load error:', err);
        setStatus('html2canvas failed to load — opening printable view as fallback.');
        openPrintableWindow(container.outerHTML);
        alert('Renderer failed to load. A printable version has been opened in a new tab — save/print it.');
        submitBtn.disabled = false;
        return;
      }

      setStatus('Rendering the form into an image...');
      
      // Hide the Download button before rendering
      submitBtn.style.display = 'none';

      try {
        const canvas = await window.html2canvas(container, {
          useCORS: true,
          scale: 2,
          logging: false,
        });
        if (!canvas) throw new Error('Rendering returned no canvas');

        setStatus('Converting to image file...');
        canvas.toBlob(
          (blob) => {
            // Restore the button visibility
            submitBtn.style.display = '';

            if (!blob) {
              setStatus('Failed to create image blob.');
              alert('Failed to create image file.');
              submitBtn.disabled = false;
              return;
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'leave_request.jpg';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            setStatus('Form downloaded successfully.');
            submitBtn.disabled = false;
          },
          'image/jpeg',
          0.92
        );
      } catch (err) {
        console.error('Render error:', err);
        // Restore the button visibility in case of error
        submitBtn.style.display = '';

        setStatus('Error generating image. Opening printable view as fallback.');
        openPrintableWindow(container.outerHTML);
        alert('Error generating the image. A printable version has been opened in a new tab — please save it.');
        submitBtn.disabled = false;
      }
    }

    function openPrintableWindow(html) {
      const w = window.open('', '_blank');
      const styles = Array.from(
        document.querySelectorAll('style, link[rel="stylesheet"]')
      )
        .map((n) => n.outerHTML)
        .join('\n');
      w.document.write(
        '<!doctype html><html><head><meta charset="utf-8"><title>Printable Leave Request</title>' +
          styles +
          '</head><body>'
      );
      w.document.write(html);
      w.document.write('</body></html>');
      w.document.close();
    }

    submitBtn.addEventListener('click', submitHandler);
    start.addEventListener('change', updateDays);
    start.addEventListener('input', updateDays);
    end.addEventListener('change', updateDays);
    end.addEventListener('input', updateDays);
    leaveDuration.addEventListener('change', updateDays);

    addInputListeners();
    updateDays();
  })();
</script>

</body>
</html>
